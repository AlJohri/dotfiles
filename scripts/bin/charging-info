#!/bin/bash
# Display USB-C Power Delivery and charging information
#
# Battery charging rate info (1C charging):
# https://community.frame.work/t/how-fast-can-the-battery-be-charged/34196/8
#
# "On both Framework Laptop 13 and Framework Laptop 16, the batteries are
# designed to charge at 1C, and the charging circuitry will only ever charge
# up to that rate, regardless of the power adapter wattage. That means up to
# 55W/61W on 13 and 85W on 16."
#
# 1C means the charge rate in watts equals the battery capacity in Wh.
# There's ~5-10W loss in charging circuitry, so adapters need extra headroom.

set -euo pipefail

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
BOLD='\033[1m'
DIM='\033[2m'
NC='\033[0m' # No Color

# Get battery capacity in Wh (this is the 1C charging limit)
get_battery_capacity_wh() {
    local energy_uw charge_ua voltage_uv

    # Try energy_full_design first (in µWh)
    if [[ -f /sys/class/power_supply/BAT1/energy_full_design ]]; then
        energy_uw=$(cat /sys/class/power_supply/BAT1/energy_full_design 2>/dev/null || echo 0)
        if [[ "$energy_uw" -gt 0 ]]; then
            awk "BEGIN {printf \"%.0f\", $energy_uw / 1000000}"
            return
        fi
    fi

    # Fall back to calculating from charge (µAh) * voltage (µV)
    if [[ -f /sys/class/power_supply/BAT1/charge_full_design && -f /sys/class/power_supply/BAT1/voltage_min_design ]]; then
        charge_ua=$(cat /sys/class/power_supply/BAT1/charge_full_design 2>/dev/null || echo 0)
        voltage_uv=$(cat /sys/class/power_supply/BAT1/voltage_min_design 2>/dev/null || echo 0)
        if [[ "$charge_ua" -gt 0 && "$voltage_uv" -gt 0 ]]; then
            # (µAh * µV) / 10^12 = Wh
            awk "BEGIN {printf \"%.0f\", ($charge_ua * $voltage_uv) / 1000000000000}"
            return
        fi
    fi

    echo "0"
}

BATTERY_CAPACITY_WH=$(get_battery_capacity_wh)
LAPTOP_NAME=$(cat /sys/class/dmi/id/product_name 2>/dev/null || echo "Unknown")

print_header() {
    echo -e "\n${BOLD}${BLUE}═══ $1 ═══${NC}"
}

print_warning() {
    echo -e "${YELLOW}⚠ $1${NC}"
}

print_good() {
    echo -e "${GREEN}✓ $1${NC}"
}

print_bad() {
    echo -e "${RED}✗ $1${NC}"
}

# Get battery info
print_header "Battery Status"

if [[ -f /sys/class/power_supply/BAT1/uevent ]]; then
    source /sys/class/power_supply/BAT1/uevent 2>/dev/null || true

    capacity="${POWER_SUPPLY_CAPACITY:-?}"
    status="${POWER_SUPPLY_STATUS:-Unknown}"

    # Calculate current power draw (voltage * current)
    if [[ -n "${POWER_SUPPLY_VOLTAGE_NOW:-}" && -n "${POWER_SUPPLY_CURRENT_NOW:-}" ]]; then
        voltage_v=$(awk "BEGIN {printf \"%.2f\", ${POWER_SUPPLY_VOLTAGE_NOW}/1000000}")
        current_a=$(awk "BEGIN {printf \"%.2f\", ${POWER_SUPPLY_CURRENT_NOW}/1000000}")
        power_w=$(awk "BEGIN {printf \"%.1f\", ($voltage_v * $current_a)}")

        echo -e "  Battery:      ${BOLD}${capacity}%${NC} (${status})"
        echo -e "  Power:        ${BOLD}${power_w}W${NC} @ ${voltage_v}V / ${current_a}A"
    else
        echo -e "  Battery:      ${BOLD}${capacity}%${NC} (${status})"
    fi

    # Time to full if charging
    if command -v upower &>/dev/null; then
        time_to_full=$(upower -i /org/freedesktop/UPower/devices/battery_BAT1 2>/dev/null | grep "time to full" | awk '{print $4, $5}')
        if [[ -n "$time_to_full" ]]; then
            echo -e "  Time to full: ${CYAN}${time_to_full}${NC}"
        fi
    fi
else
    echo "  No battery found"
fi

# Find active charging port
print_header "USB-C Power Delivery"

active_port=""
for port in /sys/class/typec/port*; do
    [[ -d "$port" ]] || continue
    [[ "$port" =~ -cable|-partner|-plug ]] && continue

    power_role=$(cat "$port/power_role" 2>/dev/null || echo "")
    if [[ "$power_role" == *"[sink]"* ]]; then
        active_port="$port"
        port_name=$(basename "$port")
        echo -e "  Active port:  ${BOLD}${port_name}${NC} (receiving power)"
        break
    fi
done

if [[ -z "$active_port" ]]; then
    echo -e "  ${DIM}No USB-C charger connected${NC}"
    exit 0
fi

# Get negotiated power from UCSI
print_header "Negotiated Power"

negotiated_current_a="0"
for psy in /sys/class/power_supply/ucsi-source-psy-*; do
    [[ -f "$psy/online" ]] || continue
    online=$(cat "$psy/online" 2>/dev/null)
    [[ "$online" == "1" ]] || continue

    voltage_now=$(cat "$psy/voltage_now" 2>/dev/null || echo 0)
    current_max=$(cat "$psy/current_max" 2>/dev/null || echo 0)

    voltage_v=$(awk "BEGIN {printf \"%.1f\", ${voltage_now}/1000000}")
    negotiated_current_a=$(awk "BEGIN {printf \"%.2f\", ${current_max}/1000000}")
    power_w=$(awk "BEGIN {printf \"%.0f\", ($voltage_v * $negotiated_current_a)}")

    echo -e "  Voltage:      ${BOLD}${voltage_v}V${NC}"
    echo -e "  Max current:  ${BOLD}${negotiated_current_a}A${NC}"
    echo -e "  Max power:    ${BOLD}${power_w}W${NC}"
    break
done

# Cable info
print_header "Cable"

port_name=$(basename "$active_port")
cable_path="/sys/class/typec/${port_name}-cable"

# Check for UCSI errors that prevent proper cable detection
ucsi_errors=$(dmesg 2>/dev/null | grep -c "ucsi_acpi.*unknown error" || echo "0")

if [[ -d "$cable_path" ]]; then
    cable_type=$(cat "$cable_path/type" 2>/dev/null || echo "unknown")
    plug_type=$(cat "$cable_path/plug_type" 2>/dev/null || echo "unknown")
    pd_rev=$(cat "$cable_path/usb_power_delivery_revision" 2>/dev/null || echo "unknown")

    echo -e "  Type:         ${BOLD}${cable_type}${NC}"
    echo -e "  Plug:         ${plug_type}"

    # Check for e-marker
    if [[ -d "$cable_path/${port_name}-plug0/identity" ]]; then
        print_good "E-marked cable (5A capable)"
    elif [[ "$plug_type" == "type-a" && "$pd_rev" == "0.0" ]]; then
        # UCSI isn't reporting cable info properly - common on Framework laptops
        echo -e "  ${DIM}(Cable identity not reported by firmware)${NC}"
    elif [[ "$cable_type" == "passive" ]]; then
        print_warning "Passive cable without e-mark (limited to 3A / 60W)"
    fi
else
    echo -e "  ${DIM}No cable info available${NC}"
fi

# Charger capabilities
print_header "Charger Capabilities (PDOs)"

partner_pd="${active_port}/${port_name}-partner/usb_power_delivery"
max_charger_power=0

if [[ -L "$partner_pd" ]]; then
    pd_path=$(readlink -f "$partner_pd")
    caps_path="$pd_path/source-capabilities"

    if [[ -d "$caps_path" ]]; then
        echo -e "  ${DIM}Profile        Voltage    Current    Power${NC}"
        echo -e "  ${DIM}─────────────────────────────────────────${NC}"

        # Collect PDO info into array for sorting, track max power
        pdo_lines=()
        for pdo in "$caps_path"/*fixed_supply "$caps_path"/*programmable_supply; do
            [[ -d "$pdo" ]] || continue
            pdo_name=$(basename "$pdo")

            if [[ "$pdo_name" == *"fixed_supply"* ]]; then
                voltage=$(cat "$pdo/voltage" 2>/dev/null || echo "0")
                current=$(cat "$pdo/maximum_current" 2>/dev/null || echo "0")

                # Convert from mV/mA to V/A
                voltage_v=${voltage%mV}
                voltage_v=$(awk "BEGIN {printf \"%.0f\", ${voltage_v:-0}/1000}")
                current_a=${current%mA}
                current_a=$(awk "BEGIN {printf \"%.1f\", ${current_a:-0}/1000}")
                power_w=$(awk "BEGIN {printf \"%.0f\", ($voltage_v * $current_a)}")

                if (( power_w > max_charger_power )); then
                    max_charger_power=$power_w
                fi

                # Store with numeric sort key
                pdo_lines+=("$(printf "%03d Fixed          %4sV      %4sA      %4sW" "$voltage_v" "$voltage_v" "$current_a" "$power_w")")

            elif [[ "$pdo_name" == *"programmable_supply"* ]]; then
                min_v=$(cat "$pdo/minimum_voltage" 2>/dev/null || echo "0")
                max_v=$(cat "$pdo/maximum_voltage" 2>/dev/null || echo "0")
                current=$(cat "$pdo/maximum_current" 2>/dev/null || echo "0")

                min_v=${min_v%mV}
                min_v=$(awk "BEGIN {printf \"%.1f\", ${min_v:-0}/1000}")
                max_v=${max_v%mV}
                max_v=$(awk "BEGIN {printf \"%.0f\", ${max_v:-0}/1000}")
                current_a=${current%mA}
                current_a=$(awk "BEGIN {printf \"%.1f\", ${current_a:-0}/1000}")

                # Use max voltage as sort key for PPS
                pdo_lines+=("$(printf "%03.0f PPS            %s-%.0fV    %4sA" "$max_v" "$min_v" "$max_v" "$current_a")")
            fi
        done

        # Sort and print (remove sort key prefix)
        printf '%s\n' "${pdo_lines[@]}" | sort -n | sed 's/^[0-9]* /  /'

        echo ""
        echo -e "  Max charger:  ${BOLD}${max_charger_power}W${NC}"
    fi
else
    echo -e "  ${DIM}No PD info available${NC}"
fi

# Summary / Recommendations
print_header "Summary"

cable_type=$(cat "$cable_path/type" 2>/dev/null || echo "unknown")
plug_type=$(cat "$cable_path/plug_type" 2>/dev/null || echo "unknown")
pd_rev=$(cat "$cable_path/usb_power_delivery_revision" 2>/dev/null || echo "unknown")
negotiated_power_w=$(awk "BEGIN {printf \"%.0f\", ($negotiated_current_a * 20)}")

# Calculate recommended adapter wattage (1C + ~10W for charging circuit losses)
recommended_adapter_w=$((BATTERY_CAPACITY_WH + 10))

# Check if we know the battery capacity (1C charging limit)
if [[ "$BATTERY_CAPACITY_WH" -gt 0 ]]; then
    echo -e "  Laptop:       ${BOLD}${LAPTOP_NAME}${NC}"
    echo -e "  Battery:      ${BOLD}${BATTERY_CAPACITY_WH}Wh${NC}"
    echo -e "  1C charge:    ${BOLD}${BATTERY_CAPACITY_WH}W${NC} max (need >${recommended_adapter_w}W adapter)"
    echo ""

    if [[ "${max_charger_power:-0}" -ge "$recommended_adapter_w" ]]; then
        print_good "Charger (${max_charger_power}W) can deliver full ${BATTERY_CAPACITY_WH}W charging rate"
    elif [[ "${max_charger_power:-0}" -ge "$BATTERY_CAPACITY_WH" ]]; then
        print_good "Charger (${max_charger_power}W) is close to ${BATTERY_CAPACITY_WH}W limit (may be slightly slower)"
    else
        print_warning "Charger (${max_charger_power}W) is below ${BATTERY_CAPACITY_WH}W - charging will be slower"
    fi

    # Check if negotiated power is near the 1C limit
    if [[ "$negotiated_power_w" -ge "$BATTERY_CAPACITY_WH" ]]; then
        print_good "Negotiated power (~${negotiated_power_w}W) is at battery's 1C limit"
    fi
elif [[ -d "$cable_path/${port_name}-plug0/identity" ]]; then
    print_good "E-marked cable detected - full power available"
elif [[ "$plug_type" == "type-a" && "$pd_rev" == "0.0" ]]; then
    # UCSI not reporting cable info - can't determine cable limitation
    print_good "Power delivery negotiated successfully"
    echo -e "  ${DIM}(Cable specs not reported by firmware - cannot verify e-mark)${NC}"
elif [[ "$cable_type" == "passive" ]] && awk "BEGIN {exit !($negotiated_current_a < 4.5)}"; then
    if [[ "${max_charger_power:-0}" -gt 60 ]]; then
        print_bad "Cable limiting power! Charger supports ${max_charger_power}W but cable limits to ~60W"
        echo -e "  ${CYAN}Recommendation: Use an e-marked 100W USB-C cable${NC}"
    else
        print_good "Cable is adequate for this charger"
    fi
else
    print_good "Power delivery appears normal"
fi

echo ""
