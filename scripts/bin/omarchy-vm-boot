#!/usr/bin/env bash
set -euo pipefail

# Boot an existing Omarchy QEMU VM (no ISO attached).
#
# Usage:
#   omarchy-vm-boot
#
# Snapshots:
#   Save:    omarchy-vm-snapshot save <name>
#   Restore: omarchy-vm-snapshot restore <name>

source "$(dirname "$0")/omarchy-vm-common"

if [[ ! -f "$DISK" ]]; then
    echo "No VM disk found at $DISK" >&2
    echo "Run omarchy-vm-install first." >&2
    exit 1
fi

echo "==> Booting QEMU..."
echo "    Disk: $DISK"
echo "    SSH:  ssh -p 2222 localhost"
echo "          (first time: sudo ufw allow 22 && sudo systemctl enable --now sshd)"
echo ""
echo "    VNC:  vncviewer localhost:5901  (clipboard works, install: sudo pacman -S tigervnc)"
echo "          (in VM: sudo ufw allow 5900 && wayvnc 0.0.0.0 5900)"
echo ""
echo "    Inside VM, mount dotfiles with:"
echo "      sudo mount -t 9p -o trans=virtio dotfiles ~/dotfiles"
echo ""

exec qemu-system-x86_64 \
    "${QEMU_BASE_ARGS[@]}" \
    -drive file="$DISK",format=qcow2,if=none,id=drive0 \
    -device virtio-blk-pci,drive=drive0,bootindex=1
