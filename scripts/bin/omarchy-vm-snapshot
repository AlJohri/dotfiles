#!/usr/bin/env bash
set -euo pipefail

# Save and restore QEMU VM snapshots.
#
# Usage:
#   omarchy-vm-snapshot save <name>
#   omarchy-vm-snapshot restore <name>
#   omarchy-vm-snapshot list

source "$(dirname "$0")/omarchy-vm-common"

SNAP_DIR="$WORK_DIR/snapshots"
mkdir -p "$SNAP_DIR"

case "${1:-}" in
    save)
        name="${2:?Usage: omarchy-vm-snapshot save <name>}"
        echo "==> Saving snapshot '$name'..."
        echo "    $DISK -> $SNAP_DIR/$name.qcow2"
        cp "$DISK" "$SNAP_DIR/$name.qcow2"
        echo "    $OVMF_VARS -> $SNAP_DIR/$name-OVMF_VARS.4m.fd"
        cp "$OVMF_VARS" "$SNAP_DIR/$name-OVMF_VARS.4m.fd"
        echo "==> Saved snapshot: $name"
        ;;
    restore)
        name="${2:?Usage: omarchy-vm-snapshot restore <name>}"
        [[ -f "$SNAP_DIR/$name.qcow2" ]] || { echo "Snapshot '$name' not found" >&2; exit 1; }
        echo "==> Restoring snapshot '$name'..."
        echo "    $SNAP_DIR/$name.qcow2 -> $DISK"
        cp "$SNAP_DIR/$name.qcow2" "$DISK"
        echo "    $SNAP_DIR/$name-OVMF_VARS.4m.fd -> $OVMF_VARS"
        cp "$SNAP_DIR/$name-OVMF_VARS.4m.fd" "$OVMF_VARS"
        echo "==> Restored snapshot: $name"
        echo "    Boot the VM with: omarchy-vm-boot"
        ;;
    list)
        for f in "$SNAP_DIR"/*.qcow2; do
            [[ -f "$f" ]] || { echo "No snapshots found"; exit 0; }
            name=$(basename "$f" .qcow2)
            echo "$name  $f"
        done
        ;;
    *)
        echo "Usage: omarchy-vm-snapshot {save|restore|list} [name]" >&2
        exit 1
        ;;
esac
